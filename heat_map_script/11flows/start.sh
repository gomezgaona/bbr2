#!/bin/bash
i=0
#0.1BDP
limit=(2621 5243 7864 10486 13107 15729 18350 20972 23593 26214 5243 10486 15729 20972 26214 31457 36700 41943 47186 52429 7864 15729 23593 31457 39322 47186 55050 62915 70779 78643 10486 20972 31457 41943 52429 62915 73400 83886 94372 104858 13107 26214 39322 52429 65536 78643 91750 104858 117965 131072 26214 52429 78643 104858 131072 157286 183501 209715 235930 262144 52429 104858 157286 209715 262144 314573 367002 419430 471859 524288 78643 157286 235930 314573 393216 471859 550502 629146 707789 786432 104858 209715 314573 419430 524288 629146 734003 838861 943718 1048576 131072 262144 393216 524288 655360 786432 917504 1048576 1179648 1310720 262144 524288 786432 1048576 1310720 1572864 1835008 2097152 2359296 2621440 524288 1048576 1572864 2097152 2621440 3145728 3670016 4194304 4718592 5242880 786432 1572864 2359296 3145728 3932160 4718592 5505024 6291456 7077888 7864320 1048576 2097152 3145728 4194304 5242880 6291456 7340032 8388608 9437184 10485760 1310720 2621440 3932160 5242880 6553600 7864320 9175040 10485760 11796480 13107200)
#1BDP
#limit=(26214 52429 78643 104858 131072 157286 183501 209715 235930 262144 52429 104858 157286 209715 262144 314573 367002 419430 471859 524288 78643 157286 235930 314573 393216 471859 550502 629146 707789 786432 104858 209715 314573 419430 524288 629146 734003 838861 943718 1048576 131072 262144 393216 524288 655360 786432 917504 1048576 1179648 1310720 262144 524288 786432 1048576 1310720 1572864 1835008 2097152 2359296 2621440 524288 1048576 1572864 2097152 2621440 3145728 3670016 4194304 4718592 5242880 786432 1572864 2359296 3145728 3932160 4718592 5505024 6291456 7077888 7864320 1048576 2097152 3145728 4194304 5242880 6291456 7340032 8388608 9437184 10485760 1310720 2621440 3932160 5242880 6553600 7864320 9175040 10485760 11796480 13107200 2621440 5242880 7864320 10485760 13107200 15728640 18350080 20971520 23592960 26214400 5242880 10485760 15728640 20971520 26214400 31457280 36700160 41943040 47185920 52428800 7864320 15728640 23592960 31457280 39321600 47185920 55050240 62914560 70778880 78643200 10485760 20971520 31457280 41943040 52428800 62914560 73400320 83886080 94371840 104857600 13107200 26214400 39321600 52428800 65536000 78643200 91750400 104857600 117964800 131072000)
#10BDP
#limit=(262144 524288 786432 1048576 1310720 1572864 1835008 2097152 2359296 2621440 524288 1048576 1572864 2097152 2621440 3145728 3670016 4194304 4718592 5242880 786432 1572864 2359296 3145728 3932160 4718592 5505024 6291456 7077888 7864320 1048576 2097152 3145728 4194304 5242880 6291456 7340032 8388608 9437184 10485760 1310720 2621440 3932160 5242880 6553600 7864320 9175040 10485760 11796480 13107200 2621440 5242880 7864320 10485760 13107200 15728640 18350080 20971520 23592960 26214400 5242880 10485760 15728640 20971520 26214400 31457280 36700160 41943040 47185920 52428800 7864320 15728640 23592960 31457280 39321600 47185920 55050240 62914560 70778880 78643200 10485760 20971520 31457280 41943040 52428800 62914560 73400320 83886080 94371840 104857600 13107200 26214400 39321600 52428800 65536000 78643200 91750400 104857600 117964800 131072000 26214400 52428800 78643200 104857600 131072000 157286400 183500800 209715200 235929600 262144000 52428800 104857600 157286400 209715200 262144000 314572800 367001600 419430400 471859200 524288000 78643200 157286400 235929600 314572800 393216000 471859200 550502400 629145600 707788800 786432000 104857600 209715200 314572800 419430400 524288000 629145600 734003200 838860800 943718400 1048576000 131072000 262144000 393216000 524288000 655360000 786432000 917504000 1048576000 1179648000 1310720000)

burst=(10000 20000 30000 40000 50000 100000 200000 300000 400000 500000 1000000 2000000 3000000 4000000 5000000)
x_RTT=(10 20 30 40 50 60 70 80 90 100)
y_BW=(20 40 60 80 100 200 400 600 800 1000 2000 4000 6000 8000 10000)

sudo tc qdisc del dev s1-eth1 root 2> /dev/null
sudo tc qdisc add dev s1-eth1 root handle 1: netem delay "${x_RTT[1]}"ms

sudo tc qdisc del dev s2-eth2 root 2> /dev/null
sudo tc qdisc add dev s2-eth2 root handle 1: tbf rate 1gbit burst 500000 limit "${limit[1]}"
#sudo tc qdisc add dev s2-eth2 parent 1: handle 2: fq_codel

rm -rf /home/Test_Results/
mkdir -p /home/Test_Results/ && cd /home/Test_Results/

i=1
while [ $i -le 11 ]; do
	/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_wmem=\"10240 87380 1310720000\" > /dev/null
	/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_rmem=\"10240 87380 1310720000\" > /dev/null
	sudo /home/research/mininet/util/m "h$i" tc qdisc del dev "h$i-eth0" root 2> /dev/null
	#sudo /home/research/mininet/util/m "h$i" tc qdisc add dev "h$i-eth0" root fq pacing maxrate 9.4mbit

	if [ $i -le 1 ]; then
		/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_congestion_control=bbr2 > /dev/null
		#sudo /home/research/mininet/util/m "h$i" tc qdisc add dev h"$i"-eth0 root netem delay 10ms
	elif [ $i -le 11 ]; then
		/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_congestion_control=cubic > /dev/null
		#sudo /home/research/mininet/util/m "h$i" tc qdisc add dev h"$i"-eth0 root netem delay 50ms
	fi
	i=`expr $i + 1`
done
i=101
while [ $i -le 111 ]; do
	/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_wmem=\"10240 87380 1310720000\" > /dev/null
	/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_rmem=\"10240 87380 1310720000\" > /dev/null
	if [ $i -le 101 ]; then
		/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_congestion_control=bbr2 > /dev/null
	elif [ $i -le 111 ]; then
		/home/research/mininet/util/m "h$i" sysctl -w net.ipv4.tcp_congestion_control=cubic > /dev/null
	fi
	/home/research/mininet/util/m "h$i" iperf3 -s > /dev/null &

	i=`expr $i + 1`
done

echo "Running main script"
i=0
m=0
while [ $m -lt "${#y_BW[@]}" ]; do
	n=0
	while [ $n -lt "${#x_RTT[@]}" ]; do
		echo "RTT = ${y_BW[$m]}Mbps"
		echo "BW = ${x_RTT[$n]}ms"
		sudo tc qdisc change dev s1-eth1 root handle 1: netem delay "${x_RTT[$n]}ms"
		sudo tc qdisc change dev s2-eth2 root handle 1: tbf rate "${y_BW[$m]}mbit" burst "${burst[$m]}" limit "${limit[$i]}"
		sleep 7
		j=1
		while [ $j -le 5 ]; do
			k=1
			echo -e "\t Run #: $j"
			while [ $k -le 11 ]; do
				mkdir "h_${m}_${n}_${j}_${k}"
				/home/research/mininet/util/m "h$k" iperf3 -c "10.0.0.$(($k+100))" -t 120 -J > "h_${m}_${n}_${j}_${k}/out.json"&
				k=`expr $k + 1`
			done
			sleep 135
			j=`expr $j + 1`
		done
		i=`expr $i + 1`
		echo -e "\tLimit index=$i"
		n=`expr $n + 1`
	done
	m=`expr $m + 1`
done
sudo /home/research/BBR2_new/heat_map_test/11flows/aggregator.sh
